

<!DOCTYPE html>
<html>
	<head>
		<title>Kent Tour app</title>
	
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
		<meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
		<link href='bootstrap.css' rel='stylesheet' type='text/css' />

		<!-- Map assets -->
		<link rel="stylesheet" href="http://www.kent.ac.uk/internationalmaps/bower_components/leaflet/dist/leaflet.css" />
		<link rel="stylesheet" href="http://www.kent.ac.uk/internationalmaps/bower_components/font-awesome/css/font-awesome.min.css" />
		<link rel="stylesheet" href="http://www.kent.ac.uk/internationalmaps/bower_components/leaflet-awesome-markers/dist/leaflet.awesome-markers.css" />

		<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.min.css" media="all" rel="stylesheet" type="text/css">

<link rel="stylesheet" href="http://www.kent.ac.uk/internationalmaps/bower_components/leaflet-awesome-markers/dist/leaflet.awesome-markers.css" />


		<style>
			header {
				background-color: #041d5d;
				padding:10px;
			}
			header h1 {
				font-size:2em; 
				color:#fff;
				margin-top:0px;

				margin-bottom:0px;
			}

			#map {height:300px;width:100%;}

			.fa {}

			.nearby .row {
				border-top: solid 1px;
				border-bottom: solid 1px;
				margin-top:2px;
			}
			.nearby .row .fa {
				font-size:2.5em; 
				margin-top:14px;
			}
		</style>


		<link rel="stylesheet" href="style.css" />


	</head>
	<body>
	
	<div class='container-fluid'>
	



	<!--<header class='row'>
			<h1>Experience Kent</h1>
		</header>

-->


<div class="row">
	<div class="col-12-sm">
		<header class="kent-branding section">
			<img src="images/kent-logo.png" width="180em"/>

		
			
		</header>

		<div class="section-header"> <i class="ico icon-chevron-left"></i> <a href="home.html">Experience Kent</a> / Canterbury  <i class="ico icon-info-sign"></i></div>

	</div>
</div>




		<div class='row'>
			<div class='col-12-sm'>
				<div  id='map'></div>
			</div>
		</div>

		


		<div class="result-options">
			<h2>Nearby you:</h2>
			<a class="route" href="#">Give me a guided route</a>
		</div>





		<div class='nearby row'>

			
			

			<div class="col-12-sm">




			


			<ul id="nearby-locations" class="link-list key-links">
					<li><a href="#" class="ico-timetable">Loading <span class="distance">...</span> <i class="ico icon-chevron-right"></i></a></li>
			</ul>

</div>


		</div>







			<div class='poi row'>




				<div class="col-12-sm">




					<h2>Templeman Library</h2>

					
					<i class="ico close icon-remove"></i>

					<p>The hearbeat of the campus. Our new redevelopment...</p>

					<h3><i class="ico icon-chevron-right"></i> Listen</h3>
Audio file play here

					<h3><i class="ico icon-chevron-right"></i> See</h3>

Video

				</div>


			</div>










		</div>

	 </div> 


	<script src="http://www.kent.ac.uk/internationalmaps/bower_components/jquery/jquery.min.js"></script>
	<script src="math.js"></script>
	<script src="http://www.kent.ac.uk/internationalmaps/bower_components/leaflet/dist/leaflet.js"></script>
	<script src="http://www.kent.ac.uk/internationalmaps/bower_components/leaflet-awesome-markers/dist/leaflet.awesome-markers.js"></script>
	<script>
		math = mathjs();

		var tourMap = new function(){

			var here = this;

			this.data = [];

			// get the tiles
			this.tiles =  L.tileLayer('http://maptiles.kent.ac.uk/tiles/{z}/{x}/{y}.png');

			// define the map
			this.map = L.map('map',{
				layers: [ this.tiles ],
				zoom: 16,
				maxBounds: new L.LatLngBounds(new L.LatLng(90, -200), new L.LatLng(-90, 200))
			});

			this.user_location_marker = L.circle([51.29225, 1.06599], 500, {
				color: 'red',
				fillColor: '#f03',
				fillOpacity: 0.5
			});

			// Add layers
			this.layers = {
				'poi': new L.LayerGroup().addTo(this.map),
				'tours': new L.LayerGroup().addTo(this.map)	
			} 

			// Geo locate
			this.map.locate({
				watch: true,
				setView: true
			});

			// On error, send em somewhere else
			this.map.on('locationerror', function() {
	        	here.map.panTo([51.29225, 1.06599]);
	        	here.map.removeLayer( here.user_location_marker );
	    	});

			// Load in GeoJson data
	    	this.load = function(){

	    		$.ajax({
			        type: 'GET',
			        url: "geo.json",
			        contentType: "application/json",
			       // dataType: 'jsonp',
			       // jsonp: 'jsonp',
			        success: function(data){

			        	here.data = data;
						// display geojson data as a map layer
						L.geoJson(data, {
							pointToLayer: function (feature, latlng) {
								return L.marker(latlng,  
								{
									icon: L.AwesomeMarkers.icon(
										{icon: 'map-marker', markerColor: 'blue', 'prefix': 'fa'}
									) 
								});

						    },
						    onEachFeature: function (feature, marker){

								var text = '<h3>'+feature.properties.name +'</h3><p>'+feature.properties.description+'</p>';

							 	marker.bindPopup(text);
							}
						}).addTo(here.layers.poi);
					}
				});	
	    	}
	    	// on location update (i think)
			this.map.on('locationfound', function(location) {
				console.log("Location updated");
				here.update_location(location);
	        	here.update_distances(location, here.data);
	        	// update DOM with reordered lists
	        	here.renderNearBy(here.data);
	    	});

	    	this.update_location = function (user_latlng) {
				here.user_location_marker.setLatLng(user_latlng.latlng);
				here.user_location_marker.setRadius( user_latlng.accuracy );
				here.user_location_marker.addTo(here.map);
	    		
	    	}

	    	this.update_distances = function(user_latlng, data){

	    		for(var i in data.features){
	    			var feature = data.features[i];

	    			feature._distance = distance(
	    				user_latlng.longitude,
	    				user_latlng.latitude,
	    				feature.geometry.coordinates[0],
	    				feature.geometry.coordinates[1]
	    			);
	    		}

	    		data.features.sort(function(a, b){
	    			return a._distance > b._distance ? 1 : -1;
	    		});
	    	}

	    	this.renderNearBy = function(data){
	    		$('#nearby-locations').empty();
	    		for (var i = 0; i < data.features.length; i++) {
	    			var feature = data.features[i];
	    			$('#nearby-locations').append(
	    				'<li><a href="https://www.kent.ac.uk/student/my-study/">' + feature.properties.name + ' <span class="distance">' + math.round(feature._distance * 1000, 0) + ' metres</span> <i class="ico icon-chevron-right"></i></a></li>'
	    			);
	    		};
	    	}
		}
		// Load data
		tourMap.load();
		


		

		// http://stackoverflow.com/questions/27928/how-do-i-calculate-distance-between-two-latitude-longitude-points
		function distance(lat1, lon1, lat2, lon2) {
		  var R = 6371;
		  var a = 
		     0.5 - Math.cos((lat2 - lat1) * Math.PI / 180)/2 + 
		     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
		     (1 - Math.cos((lon2 - lon1) * Math.PI / 180))/2;

		  return R * 2 * Math.asin(Math.sqrt(a));
		}

		function refreshNearBy(){


		}


	</script>
	</body>
</html>
